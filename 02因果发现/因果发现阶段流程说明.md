# 因果发现阶段流程说明

## 📋 阶段概述

因果发现阶段是整个因果分析系统的核心环节，旨在从预处理后的医疗数据中识别变量间的因果关系。本阶段采用多算法并行策略，通过5种不同原理的因果发现算法确保结果的可靠性和全面性。

### 🎯 核心目标
- **主要任务**：发现疾病、检验指标、药物之间的因果关系
- **数据来源**：`01数据预处理/缩减数据_规格.csv`
- **输出成果**：多格式因果关系网络和高质量因果边集合

## 🔧 算法体系

### 1. PC算法 (`01PC算法.py`)
**算法特性**
- **类型**：基于约束的因果发现算法
- **核心原理**：通过条件独立性测试识别因果关系
- **技术优势**：
  - ✅ 适用于大规模数据集
  - ✅ 基于严格的统计独立性假设
  - ✅ 高维数据处理能力强
- **输出内容**：因果网络图、边列表、JSON结构化结果

### 2. 爬山算法 (`02爬山算法.py`)
**算法特性**
- **类型**：基于评分的因果发现算法
- **核心原理**：通过局部搜索优化网络结构评分
- **技术优势**：
  - ✅ 贪心搜索策略，计算效率高
  - ✅ 适合中等规模数据
  - ✅ 结果稳定性好
- **输出内容**：有向无环图、因果边列表、网络统计信息

### 3. 贪婪等价搜索 (`03贪婪等价搜索.py`)
**算法特性**
- **类型**：基于评分的搜索算法
- **核心原理**：在等价类空间中进行贪婪搜索
- **技术优势**：
  - ✅ 考虑马尔可夫等价类
  - ✅ 有效避免局部最优解
  - ✅ 结果更加稳定可靠
- **输出内容**：CPDAG图、因果关系矩阵、边权重信息

### 4. 树搜索 (`04树搜索.py`)
**算法特性**
- **类型**：基于树结构的因果发现
- **核心原理**：构建因果关系的层次化树状结构
- **技术优势**：
  - ✅ 层次化因果关系表示
  - ✅ 结果易于理解和解释
  - ✅ 特别适合医疗领域的层级关系
- **输出内容**：树状因果图、层级关系表、根节点分析

### 5. 专家在循环 (`05专家在循环.py`)
**算法特性**
- **类型**：结合专家知识的因果发现
- **核心原理**：融合领域专家知识和数据驱动方法
- **技术优势**：
  - ✅ 可选执行（交互式选择）
  - ✅ 结合医学先验知识
  - ✅ 提高医疗领域准确性
- **输出内容**：专家增强的因果网络、知识融合结果

## 🚀 执行流程

### 阶段一：统一算法执行 (`06统一执行脚本.py`)

#### 1. 数据准备
```
数据源：/home/zkr/因果发现/01数据预处理/缩减数据_规格.csv
格式要求：CSV格式，UTF-8编码，行为样本，列为变量
```

#### 2. 算法配置
| 算法名称 | 执行状态 | 说明 |
|---------|---------|------|
| PC算法 | 🔴 必须执行 | 基础约束算法 |
| 爬山算法 | 🔴 必须执行 | 评分优化算法 |
| 贪婪等价搜索 | 🔴 必须执行 | 等价类搜索 |
| 树搜索 | 🔴 必须执行 | 层次结构算法 |
| 专家在循环 | 🟡 可选执行 | 用户交互选择 |

#### 3. 执行监控
- **并行处理**：按序执行各算法
- **结果验证**：实时检查输出文件完整性
- **性能统计**：记录执行时间和成功率
- **错误处理**：自动捕获和记录异常信息

### 阶段二：高级因果边筛选 (`07因果边筛选算法.py`)

#### 1. 数据整合
- **结果收集**：从5个算法结果文件夹收集所有因果边
- **格式标准化**：统一边的表示格式（源节点 → 目标节点）
- **去重处理**：识别和合并重复的因果边

#### 2. 多维度评分系统
| 评分维度 | 权重 | 说明 |
|---------|------|------|
| 频次评分 | 30% | 基于因果边在算法中的出现频次 |
| 多样性评分 | 25% | 评估支持算法的类型多样性 |
| 算法一致性评分 | 25% | 根据算法权重计算一致性 |
| 网络拓扑评分 | 20% | 5种中心性指标综合评估 |

#### 3. 智能筛选机制
- **自适应阈值**：肘部法则、聚类分析、异常检测
- **质量分层**：铂金、黄金、白银、青铜四级质量体系
- **统计验证**：基于Z-score的统计显著性检验

## 📁 文件结构

```
02因果发现/
├── 🔧 算法脚本
│   ├── 01PC算法.py                    # PC算法实现
│   ├── 02爬山算法.py                  # 爬山算法实现
│   ├── 03贪婪等价搜索.py              # 贪婪等价搜索实现
│   ├── 04树搜索.py                    # 树搜索算法实现
│   ├── 05专家在循环.py                # 专家在循环算法实现
│   ├── 06统一执行脚本.py              # 统一执行控制器
│   └── 07因果边筛选算法.py            # 高级筛选算法
├── 📊 算法结果
│   ├── 01PC算法结果/                  # PC算法输出
│   ├── 02爬山算法结果/                # 爬山算法输出
│   ├── 03贪婪等价搜索结果/            # 贪婪等价搜索输出
│   ├── 04树搜索结果/                  # 树搜索输出
│   ├── 05专家在循环结果/              # 专家在循环输出
│   ├── 06统一执行结果/                # 执行日志和报告
│   └── 07候选因果边集合/              # 最终筛选结果
└── 📋 说明文档
    ├── 08_1因果发现阶段流程说明.md    # 本文档
    └── 08_2因果发现阶段结果说明.md    # 结果说明文档
```

## ⚙️ 技术规格

### 环境要求
```python
# 核心依赖
Python >= 3.7
pandas >= 1.3.0
numpy >= 1.21.0
matplotlib >= 3.4.0
networkx >= 2.6.0
pgmpy >= 0.1.17
scikit-learn >= 1.0.0
```

### 硬件建议
| 资源类型 | 最低要求 | 推荐配置 |
|---------|---------|---------|
| 内存 | 4GB | 8GB+ |
| CPU | 双核 | 四核+ |
| 存储 | 2GB | 5GB+ |
| 操作系统 | Linux/Windows | Linux |

### 数据要求
- **格式**：CSV文件，UTF-8编码
- **结构**：行为样本，列为变量
- **类型**：数值型数据（已预处理）
- **规模**：建议样本数 > 100，变量数 < 1000

## 🎛️ 使用指南

### 快速开始
```bash
# 1. 进入工作目录
cd /home/zkr/因果发现/02因果发现

# 2. 执行统一脚本
python 06统一执行脚本.py

# 3. 运行高级筛选
python 07因果边筛选算法.py
```

### 执行策略
| 场景 | 推荐策略 | 说明 |
|------|---------|------|
| 首次分析 | 执行所有算法 | 获得最全面的结果 |
| 快速验证 | 跳过专家在循环 | 节省计算时间 |
| 精确分析 | 包含专家在循环 | 提高医学准确性 |
| 大规模数据 | 仅执行PC+爬山 | 平衡效率和质量 |

### 参数调优建议
- **PC算法**：调整显著性水平（默认0.05）
- **爬山算法**：选择合适的评分函数（AIC/BIC）
- **筛选算法**：根据数据规模调整质量阈值

## 🔍 质量保证

### 多重验证机制
1. **算法交叉验证**：5种算法相互验证
2. **统计显著性检验**：基于频次分布的Z-score
3. **网络拓扑分析**：5种中心性指标综合评估
4. **专家知识融合**：结合医学领域知识

### 结果可靠性指标
- **算法一致性**：多算法支持的边更可靠
- **统计显著性**：高频次边具有统计学意义
- **网络重要性**：高中心性节点更重要
- **医学合理性**：符合医学常识的关系

## 🚨 故障排除

### 常见问题及解决方案

#### 数据相关问题
| 问题 | 原因 | 解决方案 |
|------|------|---------|
| 数据路径错误 | 文件路径不正确 | 检查并修正文件路径 |
| 数据格式错误 | CSV格式不标准 | 重新预处理数据 |
| 编码问题 | 非UTF-8编码 | 转换为UTF-8编码 |

#### 算法执行问题
| 问题 | 原因 | 解决方案 |
|------|------|---------|
| 内存不足 | 数据规模过大 | 减少变量数或增加内存 |
| 算法失败 | 数据质量问题 | 检查数据统计特性 |
| 结果异常 | 参数设置不当 | 调整算法参数 |

#### 性能优化建议
- **数据预处理**：确保数据质量和格式正确
- **参数调优**：根据数据特点调整算法参数
- **资源管理**：合理分配计算资源
- **结果验证**：定期检查中间结果

## 📈 后续流程

完成因果发现阶段后，将进入：

1. **03多方法参数学习**：学习因果网络的参数
2. **04贝叶斯中介分析**：分析因果路径和中介效应
3. **05三角测量**：多方法验证因果关系
4. **05知识图谱构建**：构建结构化知识图谱

## 📞 技术支持

如遇到技术问题，请：
1. 查看执行日志文件获取详细错误信息
2. 验证数据预处理结果的正确性
3. 检查算法参数设置是否合理
4. 参考本文档的故障排除部分

---

*本文档提供了因果发现阶段的完整技术指南，确保用户能够顺利完成因果关系的发现和分析工作。*