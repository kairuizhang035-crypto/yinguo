# 因果发现结果三角验证 - 流程说明

## 概述

三角验证（Evidence Triangulation）是因果发现流程的最后一个关键阶段，通过整合前期多个分析阶段的结果，运用四维评分体系对候选因果边进行综合评估，最终识别出高置信度的核心因果边。

## 分析目标

- **整合多源证据**：综合结构发现、参数学习、中介分析的结果
- **四维评分体系**：从结构一致性、参数拟合、中介支持、专家定向四个维度评估因果边
- **核心边识别**：基于联合置信度和数据质量识别最可靠的因果关系
- **质量分层**：将因果边按质量等级进行分类
- **可视化分析**：生成多种图表和网络可视化
- **结构化输出**：提供JSON格式的结构化数据和详细报告

## 输入数据源

### 1. 结构发现阶段
- **文件路径**：`../02因果发现/07候选因果边集合/高质量因果边候选集.csv`
- **数据内容**：
  - 因果边的基础信息（源节点、目标节点）
  - 算法支持度（频次评分、多样性评分、一致性评分）
  - 网络拓扑评分和统计显著性评分
  - 综合评分和质量等级
  - 支持算法列表和出现频次

### 2. 参数学习阶段
- **文件路径**：`../03多方法参数学习/05边级似然增益结果/边级似然增益汇总.csv`
- **数据内容**：
  - 各种参数学习方法的似然增益（MLE、Bayesian、EM、SEM）
  - S参数归一化分数
  - 统计拟合质量指标
  - 多方法一致性评估

### 3. 中介分析阶段
- **文件路径**：`../04贝叶斯中介分析/02贝叶斯中介分析结果/贝叶斯中介分析汇总.csv`
- **数据内容**：
  - 间接效应和直接效应
  - 中介比例和效应大小
  - 显著性概率
  - 中介路径的统计显著性

## 四维评分体系

### 1. 结构一致性评分 (α = 0.35)

**评估维度**：算法间的一致程度

**计算方法**：
```
结构一致性分数 = 频次评分 × 0.4 + 多样性评分 × 0.3 + 算法一致性评分 × 0.3
```

**评分标准**：
- 高一致性 (0.8-1.0)：多算法强一致支持，出现频次高
- 中等一致性 (0.6-0.8)：部分算法支持，有一定一致性
- 低一致性 (0.0-0.6)：算法间存在分歧，支持度较低

**数据来源**：基于13种因果发现算法的综合结果

### 2. 参数拟合评分 (β = 0.25)

**评估维度**：统计拟合质量

**计算方法**：
- 基于多种参数学习方法（MLE、Bayesian、EM、SEM）的S参数平均值
- 对于缺失数据的边，根据结构评分进行合理估计：`参数分数 = 结构分数 × 0.5`
- 反映参数学习的统计支持强度

**评分标准**：
- 高拟合 (0.8-1.0)：显著的似然增益，多方法一致
- 中等拟合 (0.6-0.8)：适度的统计支持
- 低拟合 (0.0-0.6)：统计支持较弱或缺失数据

### 3. 中介支持评分 (γ = 0.25)

**评估维度**：中介效应强度

**计算方法**：
- 基于贝叶斯中介分析的显著性概率和效应大小
- 显著路径：`中介强度 = 显著性概率 × (1 + 间接效应绝对值)`
- 非显著路径：`中介强度 = 显著性概率 × 0.3`
- 对于非中介边，根据节点类型进行调整

**节点类型权重**：
- 疾病→药物：0.9（高度合理的中介路径）
- 检验↔疾病：0.7（较为合理的中介关系）
- 检验→药物：0.6（中等合理性）
- 其他类型：0.4（基础权重）

**评分标准**：
- 强中介支持 (0.8-1.0)：显著的中介效应，路径清晰
- 中等中介支持 (0.6-0.8)：适度的中介作用
- 弱中介支持 (0.0-0.6)：中介效应不显著或缺失

### 4. 专家定向评分 (δ = 0.15)

**评估维度**：领域知识支持

**计算方法**：
```
专家定向分数 = 专家支持 × 0.6 + 领域知识评分 × 0.4
```

**专家支持**：
- ExpertInLoop_LLM算法支持：1.0
- 无专家算法支持：0.0

**领域知识评分**（基于医学常识）：
- 疾病→药物：0.95（治疗关系，高度合理）
- 疾病→检验：0.90（诊断关系，高度合理）
- 检验→疾病：0.85（诊断指示，较为合理）
- 药物→检验：0.80（药效监测，较为合理）
- 检验→药物：0.70（指导用药，中等合理）
- 药物→疾病：0.60（副作用等，需谨慎）
- 其他情况：0.50（中性评分）

## 分析流程

### 第一步：数据加载与预处理
1. **加载结构发现数据**：高质量因果边候选集（65条边）
2. **加载参数学习数据**：边级似然增益汇总结果
3. **加载中介分析数据**：贝叶斯中介分析汇总结果
4. **数据清洗和格式标准化**：统一边标识格式，处理缺失值

### 第二步：四维评分计算
1. **结构一致性评分**：基于算法支持度、频次和一致性
2. **参数拟合评分**：基于多方法似然增益的平均值
3. **中介支持评分**：基于中介效应的显著性和强度
4. **专家定向评分**：基于专家算法支持和领域知识

### 第三步：联合置信度计算
使用加权平均方法计算联合置信度：

```
联合置信度 = α×结构一致性 + β×参数拟合 + γ×中介支持 + δ×专家定向
```

其中：α=0.35, β=0.25, γ=0.25, δ=0.15

**数据质量评估**：
```
质量评分 = (1.0 + 参数数据质量 + 中介数据质量 + 专家支持质量) / 4.0
```
- 参数数据质量：有真实数据=1.0，估算数据=0.3
- 中介数据质量：有真实数据=1.0，估算数据=0.3  
- 专家支持质量：有专家支持=1.0，无专家支持=0.5

### 第四步：核心因果边识别
**双重筛选标准**：
1. **置信度筛选**：联合置信度 ≥ 0.6
2. **质量筛选**：数据质量评分 ≥ 0.6
3. **核心边定义**：同时满足置信度和质量要求的边

### 第五步：结果保存与可视化

#### 5.1 详细结果保存
- **三角验证详细结果.csv**：所有65条边的完整四维评分
- **核心因果边集合.csv**：23条核心边的详细信息
- **三角验证汇总报告.txt**：分析过程总结

#### 5.2 结构化数据保存
- **核心因果边结构化数据.json**：核心边的JSON格式数据
- **三角验证完整结果.json**：完整分析结果的结构化数据

#### 5.3 边级详细分析
- **核心边详细分析报告.txt**：每条核心边的详细分析
- **所有边分析摘要.txt**：所有边的简要分析摘要

#### 5.4 统计摘要
- **统计摘要报告.txt**：详细的统计分析结果
- **统计数据表.csv**：统计数据的表格形式

#### 5.5 可视化图表
1. **置信度分布图.png**：置信度的直方图分布
2. **核心边四维评分雷达图.png**：核心边的雷达图分析
3. **四维评分热力图.png**：所有边的四维评分热力图
4. **置信度质量散点图.png**：置信度与质量的关系图
5. **维度贡献度饼图.png**：各维度对置信度的贡献

#### 5.6 网络可视化
1. **核心因果边网络图.png**：核心边的网络图
2. **完整因果网络图.png**：所有边的网络图
3. **分层因果网络图.png**：按节点类型分层的网络图
4. **交互式网络图数据.json**：用于交互式可视化的数据
5. **网络节点数据_Gephi格式.csv**：Gephi软件的节点数据
6. **网络边数据_Gephi格式.csv**：Gephi软件的边数据

## 技术特点

### 1. 多源证据整合
- **三阶段整合**：结构发现、参数学习、中介分析
- **13种算法支持**：PC、HillClimbing、GreedyEquivalence等多种方法
- **4种参数学习方法**：MLE、Bayesian、EM、SEM
- **贝叶斯中介分析**：基于概率的中介效应评估

### 2. 权重优化设计
- **结构一致性权重最高（35%）**：体现结构发现的基础作用
- **参数拟合和中介支持权重相等（各25%）**：平衡统计和机制证据
- **专家定向权重适中（15%）**：提供理论指导但不过度依赖

### 3. 缺失数据处理
- **参数学习数据缺失**：基于结构评分估算，降权处理（×0.5）
- **中介分析数据缺失**：基于节点类型和结构评分估算，降权处理（×0.3）
- **专家支持缺失**：基于领域知识评分，确保所有边都有完整评分

### 4. 质量控制机制
- **双重筛选标准**：置信度+质量的双重保障
- **数据质量评估**：区分真实数据和估算数据
- **分层结果输出**：优秀、良好、一般三个质量层次
- **详细的评分过程记录**：每个维度的贡献度可追溯

### 5. 可视化与交互
- **多种图表类型**：分布图、雷达图、热力图、散点图、饼图
- **网络可视化**：核心边、完整网络、分层网络
- **交互式数据**：支持动态可视化和进一步分析
- **标准格式输出**：支持Gephi等专业网络分析软件

## 输出文件说明

### 1. 核心结果文件
- **核心因果边集合.csv**：23条核心边的完整信息
  - 包含四维评分、置信度、质量评分等关键指标
  - 按联合置信度降序排列
  - 边类型标识为"核心边"

### 2. 详细分析文件
- **三角验证详细结果.csv**：所有65条边的完整分析
  - 27个字段的详细信息
  - 包含各维度的原始分数和贡献度
  - 数据质量和真实性标识

### 3. 统计报告文件
- **统计摘要报告.txt**：详细的统计分析
  - 基本统计、置信度分布、质量评分分布
  - 四维评分统计、核心边专项统计
  - 维度贡献度和相关性分析

### 4. 可视化文件
- **6种统计图表**：分布、雷达、热力图等
- **4种网络图**：核心边、完整、分层、交互式
- **Gephi格式数据**：专业网络分析软件支持

### 5. 结构化数据文件
- **JSON格式**：便于程序化处理和进一步分析
- **完整元数据**：包含分析参数、时间戳等信息

## 质量保证

### 1. 数据一致性检查
- **边标识统一**：确保不同阶段数据的边标识一致
- **格式标准化**：统一"源节点 -> 目标节点"格式
- **缺失值处理**：合理的估算策略，避免数据丢失

### 2. 评分合理性验证
- **评分范围检查**：确保所有评分在[0,1]范围内
- **权重设置验证**：四维权重之和等于1.0
- **逻辑一致性**：高质量边应有高置信度

### 3. 结果可解释性
- **详细的评分依据**：每个维度的计算过程可追溯
- **贡献度分析**：各维度对最终置信度的具体贡献
- **质量标识**：区分真实数据和估算数据

## 应用建议

### 1. 结果解读
- **重点关注核心边集合**：23条高置信度、高质量的因果边
- **结合领域知识验证**：核心边的医学合理性验证
- **关注四维评分分布**：了解各维度的相对重要性

### 2. 后续分析
- **因果网络构建**：基于核心边构建因果网络模型
- **因果效应量化**：进行具体的因果效应估计
- **干预实验设计**：基于因果关系设计干预策略

### 3. 参数调优
- **权重调整**：可根据具体应用场景调整四维权重
- **阈值优化**：可调整置信度和质量阈值获得不同规模的结果集
- **方法扩展**：可增加新的评分维度或改进现有算法

### 4. 临床应用
- **治疗决策支持**：基于疾病→药物的因果边指导用药
- **诊断辅助**：基于疾病→检验的因果边辅助诊断
- **并发症预测**：基于疾病→疾病的因果边预测并发症风险
- **个性化医疗**：结合患者特征进行个性化因果推断